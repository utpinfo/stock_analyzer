<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ stockCode }} - {{ stockName }} 技術分析 (ECharts)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        .chart-container {
            margin: 10px auto;
        }

        .chart {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<h1 class="text-center mt-4">{{ stockCode }} - {{ stockName }} 技術分析</h1>


<form id="stockForm" class="row g-2 justify-content-end align-items-center mb-4 me-3">
    <div class="col-auto">
        <input type="number" class="form-control" id="analyseDaysInput" placeholder="輸入分析天數" value="{{ analyseDays }}" style="width:80px;">
    </div>
    <div class="col-auto">
        <input type="text" class="form-control" id="stockInput" placeholder="輸入股票代碼" value="{{ stockCode }}">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">查詢</button>
    </div>
</form>

<div class="chart-container">
    <div id="priceChart" class="chart"></div>
    <div id="volumeChart" class="chart" style="height:300px"></div>
    <div id="rsiChart" class="chart" style="height:250px"></div>
    <div id="macdChart" class="chart" style="height:250px"></div>
    <div id="kdjChart" class="chart" style="height:250px"></div>
</div>

<script>
    const df = {{data | safe}};
    const dates = df.map(r => new Date(r.priceDate).toLocaleDateString());
    const candleData = df.map(r => [r.open, r.close, r.low, r.high]);
    const closeData = df.map(r => r.close), ma5 = df.map(r => r['5_MA']), ma10 = df.map(r => r['10_MA']);
    const volume = df.map(r => r.volume), rsi = df.map(r => r.RSI), macd = df.map(r => r.MACD || 0);
    const kdj = df.map(r => r.KDJ || [null, null, null]);
    const reasons = df.map(r => r.reason || ''); // 空值用空字串
    function createChart(id, option) {
        const chart = echarts.init(document.getElementById(id));
        chart.setOption(option);
        return chart;
    }

    // K線 + 均線
    const minLow = Math.min(...df.map(r => r.low).filter(v => v > 0));

    let upStrong = [], upWeak = [], downWeak = [], downStrong = [];

    df.forEach((r, i) => {
        const p = [i, minLow];
        if (r.trand === 1) upStrong.push(p);
        else if (r.trand === 0.5) upWeak.push(p);
        else if (r.trand === -0.5) downWeak.push(p);
        else if (r.trand === -1) downStrong.push(p);
    });


    createChart('priceChart', {
        title: {text: 'K線圖與均線'},
        tooltip: {
            trigger: 'axis',
            axisPointer: {type: 'cross'},
            formatter: function (params) {
                const idx = params[0].dataIndex;
                let tooltipText = '';
                params.forEach(p => {
                    tooltipText += `${p.seriesName}: ${p.data}<br>`;
                });
                if (reasons[idx].trim() !== '') {
                    tooltipText += `<strong>Reason: ${reasons[idx]}</strong>`;
                }
                return tooltipText;
            },
            position: function (point, params, dom, rect, size) {
                // point = [鼠標 x, 鼠標 y]
                const x = size.viewSize[0] / 2 - size.contentSize[0] / 2; // 水平居中
                const y = point[1] - size.contentSize[1] - 10; // 鼠標上方
                return [x, y];
            }
        }, legend: {data: ['K線', '收盤', '5日均線', '10日均線', '🔺', '🔻']},
        xAxis: {type: 'category', data: dates, scale: true},
        yAxis: {scale: true, name: '價格'},
        series: [
            {
                name: 'K線',
                type: 'candlestick',
                data: candleData,
                itemStyle: {color: '#ec0000', color0: '#00da3c', borderColor: '#8A0000', borderColor0: '#008F28'}
            },
            {name: '收盤', type: 'line', data: closeData},
            {name: '5日均線', type: 'line', data: ma5},
            {name: '10日均線', type: 'line', data: ma10},
            {
                name: '🔺',
                type: 'scatter',
                data: upStrong,
                symbol: 'triangle',
                symbolSize: 12,
                itemStyle: {color: '#FF0000'},
                z: 10
            },
            {
                name: '🔺',
                type: 'scatter',
                data: upWeak,
                symbol: 'triangle',
                symbolSize: 12,
                itemStyle: {color: '#FFC0CB'},
                z: 10
            },
            {
                name: '🔻',
                type: 'scatter',
                data: downWeak,
                symbol: 'triangle',
                symbolSize: 12,
                symbolRotate: 180,
                itemStyle: {color: '#90EE90'},
                z: 10
            },
            {
                name: '🔻',
                type: 'scatter',
                data: downStrong,
                symbol: 'triangle',
                symbolSize: 12,
                symbolRotate: 180,
                itemStyle: {color: '#008000'},
                z: 10
            }
        ]
    });


    // 成交量
    createChart('volumeChart', {
        title: {text: '成交量'}, tooltip: {trigger: 'axis'},
        xAxis: {type: 'category', data: dates}, yAxis: {type: 'value', name: '成交量'},
        series: [{type: 'bar', data: volume}]
    });

    // RSI
    createChart('rsiChart', {
        title: {text: 'RSI'}, tooltip: {trigger: 'axis'},
        xAxis: {type: 'category', data: dates}, yAxis: {min: 0, max: 100, name: 'RSI'},
        series: [{type: 'line', data: rsi}],
        markLine: {data: [{yAxis: 70}, {yAxis: 30}]}
    });

    // MACD
    createChart('macdChart', {
        title: {text: 'MACD'}, tooltip: {trigger: 'axis'},
        xAxis: {type: 'category', data: dates}, yAxis: {name: 'MACD'},
        series: [
            {type: 'bar', data: macd.map(v => v > 0 ? v : 0)},
            {type: 'bar', data: macd.map(v => v < 0 ? v : 0)}
        ]
    });

    // KDJ
    createChart('kdjChart', {
        title: {text: 'KDJ'}, tooltip: {trigger: 'axis'},
        xAxis: {type: 'category', data: dates}, yAxis: {min: 0, max: 100, name: 'KDJ'},
        series: [
            {name: 'K', type: 'line', data: kdj.map(r => r[0])},
            {name: 'D', type: 'line', data: kdj.map(r => r[1])},
            {name: 'J', type: 'line', data: kdj.map(r => r[2])}
        ],
        markLine: {data: [{yAxis: 80}, {yAxis: 20}]}
    });


    const form = document.getElementById('stockForm');
    form.addEventListener('submit', function (e) {
        e.preventDefault(); // 防止表單自動提交
        const code = document.getElementById('stockInput').value.trim();
        const analyseDays = document.getElementById('analyseDaysInput').value.trim();

        if (code) {
            let url = `?stockCode=${encodeURIComponent(code)}`;
            if (analyseDays) {
                url += `&analyseDays=${encodeURIComponent(analyseDays)}`;
            }
            window.location.href = url;
        }
    });
</script>

{% if alert_msg %}
<script>
    alert("{{ alert_msg }}");
</script>
{% endif %}
</body>
</html>
