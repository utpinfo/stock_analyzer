{% extends "analysis/base.html" %}

{% block title %}
    {{ stockCode }} - {{ stockName }} æŠ€è¡“åˆ†æ (ECharts)
{% endblock %}

{% block content %}
    <h1 class="text-center mt-4">{{ stockCode }} - {{ stockName }} æŠ€è¡“åˆ†æ</h1>

    <form id="stockForm" class="row g-2 justify-content-end align-items-center mb-4 me-3">
        <div class="col-auto">
            <input type="number" class="form-control" id="analyseDaysInput" placeholder="è¼¸å…¥åˆ†æå¤©æ•¸"
                   value="{{ analyseDays }}" style="width:80px;">
        </div>
        <div class="col-auto">
            <input type="text" class="form-control" id="stockInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼" value="{{ stockCode }}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">æŸ¥è©¢</button>
        </div>
    </form>

    <div class="chart-container">
        <div id="priceChart" class="chart"></div>
        <div id="pvrChart" class="chart" style="height:250px"></div>
        <div id="volumeChart" class="chart" style="height:300px"></div>
        <div id="rsiChart" class="chart" style="height:250px"></div>
        <div id="macdChart" class="chart" style="height:250px"></div>
        <div id="kdjChart" class="chart" style="height:250px"></div>
        <div id="revenueChart" class="chart" style="height:250px"></div>
    </div>

    {% block extra_head %}
        <style>
            .chart-container {
                margin: 10px auto;
            }

            .chart {
                width: 100%;
                height: 400px;
                margin-bottom: 20px;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

        <script>
            const df = {{data | safe}};
            console.log(df);
            const dates = df.map(r => new Date(r.priceDate).toLocaleDateString());
            const candleData = df.map(r => [r.open, r.close, r.low, r.high]);
            const closeData = df.map(r => r.close), ma5 = df.map(r => r['5_MA']), ma10 = df.map(r => r['10_MA']);
            const volume = df.map(r => r.volume), rsi = df.map(r => r.RSI), pvr = df.map(r => r.ampPvr),
                macd = df.map(r => r.MACD), ma15_volume = df.map(r => r['15_V_MA']);
            const kdj = df.map(r => r.KDJ || [null, null, null]);

            // è¨ˆç®—é‡‘å‰æ­»å‰ä½ç½®
            const crossMarks = [];
            for (let i = 1; i < kdj.length; i++) {
                const [prevK, prevD] = kdj[i - 1];
                const [currK, currD] = kdj[i];

                if (prevK < prevD && currK > currD) { // é‡‘å‰
                    crossMarks.push({xAxis: dates[i], yAxis: currK, itemStyle: {color: '#FF0000'}, symbolRotate: 0});
                }
                if (prevK > prevD && currK < currD) { // æ­»å‰
                    crossMarks.push({xAxis: dates[i], yAxis: currK, itemStyle: {color: '#00FF00'}, symbolRotate: 180});
                }
            }


            const reasons = df.map(r => r.reason || ''); // ç©ºå€¼ç”¨ç©ºå­—ä¸²
            const revenues = df.map(r => r.revenue || ''); // ç©ºå€¼ç”¨ç©ºå­—ä¸²
            let validRevenue = null;

            const revenueColors = revenues.map(row => {
                let color = '#87CEFA'; // é è¨­ç¬¬ä¸€ç­†è—è‰²
                if (!row || row <= 0) return color; // ç„¡æ•ˆç°è‰²

                if (validRevenue !== null) {
                    color = row > validRevenue ? '#FF4D4D' : row < validRevenue ? '#00CC66' : color;
                }

                validRevenue = row; // æ›´æ–°å‰ä¸€ç­†æœ‰æ•ˆå€¼
                return color;
            });

            function createChart(id, option) {
                const chart = echarts.init(document.getElementById(id));
                chart.setOption(option);
                return chart;
            }

            // Kç·š + å‡ç·š
            const minLow = Math.min(...df.map(r => r.low).filter(v => v > 0));

            let upStrong = [], upWeak = [], downWeak = [], downStrong = [];

            df.forEach((r, i) => {
                const p = [i, minLow];
                if (r.trand === 1) upStrong.push(p);
                else if (r.trand === 0.5) upWeak.push(p);
                else if (r.trand === -0.5) downWeak.push(p);
                else if (r.trand === -1) downStrong.push(p);
            });


            createChart('priceChart', {
                title: {text: 'Kç·šåœ–èˆ‡å‡ç·š'},
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'cross'},
                    formatter: function (params) {
                        const idx = params[0].dataIndex;
                        const [open, close, low, high] = candleData[idx];
                        let tooltipText = `<strong style="color:blue;">${dates[idx]}</strong><br>`;
                        tooltipText += `<span style="color:red;">æ”¶: ${close}</span><br>`;
                        tooltipText += `é–‹: ${open}<br>é«˜: ${high}<br>ä½: ${low}<br>`;
                        tooltipText += `<span style="color:#FFA500;">5æ—¥: ${ma5[idx]}</span><br>`;
                        tooltipText += `<span style="color:#ADD8E6;">10æ—¥: ${ma10[idx]}</span><br>`;
                        if (reasons[idx]?.trim()) tooltipText += `<strong>Reason: ${reasons[idx]}</strong>`;
                        return tooltipText;
                    },
                    // tooltipå±…ä¸­
                    position: function (point, params, dom, rect, size) {
                        const x = size.viewSize[0] / 2 - size.contentSize[0] / 2; // æ°´å¹³å±…ä¸­
                        const y = point[1] - size.contentSize[1] - 10; // é¼ æ¨™ä¸Šæ–¹
                        return [x, y];
                    }
                }, legend: {data: ['æ”¶ç›¤', '5æ—¥å‡ç·š', '10æ—¥å‡ç·š', 'Kç·š']},
                xAxis: {type: 'category', data: dates, scale: true},
                yAxis: {scale: true, name: 'åƒ¹æ ¼'},
                series: [
                    {
                        name: 'æ”¶ç›¤',
                        type: 'line',
                        data: closeData,
                        symbol: 'none',
                        itemStyle: {color: '#FF0000'},
                        lineStyle: {width: 1}
                    },
                    {
                        name: '5æ—¥å‡ç·š',
                        type: 'line',
                        data: ma5,
                        symbol: 'none',
                        itemStyle: {color: '#FFA500'},
                        lineStyle: {width: 1}
                    },
                    {
                        name: '10æ—¥å‡ç·š',
                        type: 'line',
                        data: ma10,
                        symbol: 'none',
                        itemStyle: {color: '#ADD8E6'},
                        lineStyle: {width: 1}
                    },
                    {
                        name: 'Kç·š',
                        type: 'candlestick',
                        data: candleData,
                        itemStyle: {
                            color: '#FF0000',
                            color0: '#00da3c',
                            borderColor: '#8A0000',
                            borderColor0: '#008F28'
                        }
                    },
                    {
                        name: 'ğŸ”º',
                        type: 'scatter',
                        data: upStrong,
                        symbol: 'triangle',
                        symbolSize: 12,
                        itemStyle: {color: '#FF0000'},
                        z: 10
                    },
                    {
                        name: 'ğŸ”º',
                        type: 'scatter',
                        data: upWeak,
                        symbol: 'triangle',
                        symbolSize: 12,
                        itemStyle: {color: '#FFC0CB'},
                        z: 10
                    },
                    {
                        name: 'ğŸ”»',
                        type: 'scatter',
                        data: downWeak,
                        symbol: 'triangle',
                        symbolSize: 12,
                        symbolRotate: 180,
                        itemStyle: {color: '#90EE90'},
                        z: 10
                    },
                    {
                        name: 'ğŸ”»',
                        type: 'scatter',
                        data: downStrong,
                        symbol: 'triangle',
                        symbolSize: 12,
                        symbolRotate: 180,
                        itemStyle: {color: '#008000'},
                        z: 10
                    }
                ]
            })
            ;

            // æˆäº¤é‡
            createChart('volumeChart', {
                title: {text: 'æˆäº¤é‡'},
                tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates},
                yAxis: {type: 'value', name: 'æˆäº¤é‡'},
                series: [
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volume,
                        itemStyle: {color: '#FFC0CB'}
                    },
                    {
                        name: '15æ—¥',
                        type: 'line',
                        data: ma15_volume,  // å°æ‡‰ä½ çš„ 15_V_MA
                        symbol: 'none',     // ä¸é¡¯ç¤ºåœ“é»
                        lineStyle: {color: '#0000FF'} // ç·šé¡è‰²èˆ‡ç²—ç´°
                    }
                ],
                legend: {data: ['æˆäº¤é‡', '15æ—¥']}
            });

            // PVR
            createChart('pvrChart', {
                title: {text: 'PVR (ç•°å¸¸æ³¢å‹•)'}, tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates}, yAxis: {name: 'PVR'},
                series: [{type: 'line', data: pvr, symbol: 'none'}],
            });

            // RSI
            createChart('rsiChart', {
                title: {text: 'RSI (çŸ­ä¸­æœŸ|ç›¸å°å¼·å¼±æŒ‡æ¨™)'},
                tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates},
                yAxis: {name: 'RSI'},
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsi,
                        symbol: 'none',
                        markLine: {
                            silent: true,
                            data: [
                                {yAxis: 70, name: 'è¶…è²·ç·š', lineStyle: {color: '#008000', type: 'dashed', width: 1}},
                                {yAxis: 30, name: 'è¶…è³£ç·š', lineStyle: {color: '#FF0000', type: 'dashed', width: 1}}
                            ]
                        }
                    }
                ],
                legend: {data: ['RSI']}
            });

            // MACD
            createChart('macdChart', {
                title: {text: 'MACD (ä¸­æœŸ|è¶¨å‹¢æŒ‡æ¨™)'}, tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates}, yAxis: {name: 'MACD'},
                series: [
                    {type: 'bar', data: macd.map(v => v > 0 ? v : 0), itemStyle: {color: '#FF0000'}},
                    {type: 'bar', data: macd.map(v => v < 0 ? v : 0), itemStyle: {color: '#008000'}}
                ]
            });

            // KDJ
            createChart('kdjChart', {
                title: {text: 'KDJ (çŸ­æœŸ|éœ‡ç›ªæŒ‡æ¨™|è¶…è³£ã€çŸ­ç·šè²·è³£æ™‚æ©Ÿ)'},
                tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates},
                yAxis: {name: 'KDJ'},
                series: [
                    {
                        name: 'K (å¿«ç·š)',
                        type: 'line',
                        data: kdj.map(r => r[0]),
                        symbol: 'none',
                        itemStyle: {color: '#FFA500'},
                        lineStyle: {width: 1}
                    },
                    {
                        name: 'D (æ…¢ç·š)',
                        type: 'line',
                        data: kdj.map(r => r[1]),
                        symbol: 'none',
                        itemStyle: {color: '#ADD8E6'},
                        lineStyle: {width: 1}
                    },
                    {
                        name: 'J (åé›¢å€¼)',
                        type: 'line',
                        data: kdj.map(r => r[2]),
                        symbol: 'none',
                        itemStyle: {color: '#800080'},
                        lineStyle: {type: 'dashed', width: 1}
                    },
                    {
                        name: 'Cross',
                        type: 'scatter',
                        markPoint: {
                            data: crossMarks,
                            symbol: 'triangle',
                            symbolSize: 12
                        }
                    }
                ],
                legend: {data: ['K (å¿«ç·š)', 'D (æ…¢ç·š)', 'J (åé›¢å€¼)']}
            });

            createChart('revenueChart', {
                title: {text: 'ç‡Ÿæ”¶'},
                tooltip: {trigger: 'axis'},
                xAxis: {type: 'category', data: dates},
                yAxis: {type: 'value', name: 'ç‡Ÿæ”¶é‡‘é¡'},
                series: [
                    {
                        type: 'bar',
                        data: revenues,
                        itemStyle: {
                            color: (params) => revenueColors[params.dataIndex]  // âœ… æ ¹æ“šæ¯ç­†é¡è‰²è¨­å®š
                        }
                    }
                ]
            });

            const form = document.getElementById('stockForm');
            form.addEventListener('submit', function (e) {
                e.preventDefault(); // é˜²æ­¢è¡¨å–®è‡ªå‹•æäº¤
                const code = document.getElementById('stockInput').value.trim();
                const analyseDays = document.getElementById('analyseDaysInput').value.trim();

                if (code) {
                    let url = `?stockCode=${encodeURIComponent(code)}`;
                    if (analyseDays) {
                        url += `&analyseDays=${encodeURIComponent(analyseDays)}`;
                    }
                    window.location.href = url;
                }
            });
        </script>

    {% endblock %}

    {% if alert_msg %}
        <script>
            alert("{{ alert_msg }}");
        </script>
    {% endif %}
{% endblock %}
